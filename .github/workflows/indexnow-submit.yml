name: Submit IndexNow URLs

on:
  push:
    branches: [main]
    paths:
      - ".gitmodules"
      - "content"
      - "scripts/**"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: indexnow-${{ github.ref }}
  cancel-in-progress: true

jobs:
  submit:
    runs-on: ubuntu-latest
    env:
      INDEXNOW_HOST: ai-assisted-software-development.com
      INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY || '75c966e4569e4fa8b33c7594f417b771' }}
      INDEXNOW_BASE_URL: https://ai-assisted-software-development.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Compute content submodule SHAs
        id: content-shas
        if: github.event_name == 'push'
        run: |
          old="$(git ls-tree "${{ github.event.before }}" content | awk '{print $3}')"
          new="$(git ls-tree "${{ github.sha }}" content | awk '{print $3}')"
          if [ -z "$old" ] || [ -z "$new" ]; then
            echo "Could not determine content SHAs (old='$old', new='$new')."
            exit 0
          fi
          echo "old=$old" >> "$GITHUB_OUTPUT"
          echo "new=$new" >> "$GITHUB_OUTPUT"

      - name: Ensure content SHAs are available
        if: github.event_name == 'push'
        run: |
          git -C content fetch --no-tags --prune origin "${{ steps.content-shas.outputs.old }}" "${{ steps.content-shas.outputs.new }}" || true

      - name: Compute URLs changed in this push
        if: github.event_name == 'push'
        run: |
          python3 scripts/indexnow_urls_from_content_diff.py \
            --content-dir content \
            --notes-dir notes \
            --old-sha "${{ steps.content-shas.outputs.old }}" \
            --new-sha "${{ steps.content-shas.outputs.new }}" \
            --host "${INDEXNOW_HOST}" \
            --base-url "${INDEXNOW_BASE_URL}" \
            --include-taxonomies \
            > /tmp/indexnow_urls.txt
          wc -l /tmp/indexnow_urls.txt || true

      - name: Submit IndexNow URLs
        id: indexnow
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            if [ ! -s /tmp/indexnow_urls.txt ]; then
              echo "No URLs to submit."
              exit 0
            fi
            python3 scripts/indexnow_submit.py \
              --urls-file /tmp/indexnow_urls.txt \
              --host "${INDEXNOW_HOST}" \
              --key "${INDEXNOW_KEY}"
          else
            # Manual run fallback: submit the full sitemap (first run) or only changed lastmod URLs (subsequent runs)
            python3 scripts/indexnow_submit.py \
              --sitemap "${INDEXNOW_BASE_URL}/sitemap.xml" \
              --host "${INDEXNOW_HOST}" \
              --key "${INDEXNOW_KEY}"
          fi
