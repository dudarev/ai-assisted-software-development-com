name: Submit IndexNow URLs

on:
  workflow_run:
    workflows: ["Update content submodule"]
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: indexnow-${{ github.ref }}
  cancel-in-progress: true

jobs:
  submit:
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'repository_dispatch') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      INDEXNOW_HOST: ai-assisted-software-development.com
      INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY || '75c966e4569e4fa8b33c7594f417b771' }}
      INDEXNOW_BASE_URL: https://ai-assisted-software-development.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Compute content submodule SHAs
        id: content-shas
        if: github.event_name == 'workflow_run'
        run: |
          old="$(git ls-tree HEAD^ content 2>/dev/null | awk '{print $3}')"
          new="$(git ls-tree HEAD content 2>/dev/null | awk '{print $3}')"
          echo "old=$old" >> "$GITHUB_OUTPUT"
          echo "new=$new" >> "$GITHUB_OUTPUT"
          if [ -z "$old" ] || [ -z "$new" ]; then
            echo "Could not determine content SHAs from current/previous commit (old='$old', new='$new')."
            echo "ready=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$old" = "$new" ]; then
            echo "Content submodule SHA unchanged ($new)."
            echo "ready=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ready=true" >> "$GITHUB_OUTPUT"

      - name: Ensure content SHAs are available
        if: github.event_name == 'workflow_run' && steps.content-shas.outputs.ready == 'true'
        run: |
          git -C content fetch --no-tags --prune origin "${{ steps.content-shas.outputs.old }}" "${{ steps.content-shas.outputs.new }}" || true

      - name: Compute URLs changed in updated content
        if: github.event_name == 'workflow_run' && steps.content-shas.outputs.ready == 'true'
        run: |
          python3 scripts/indexnow_urls_from_content_diff.py \
            --content-dir content \
            --notes-dir notes \
            --old-sha "${{ steps.content-shas.outputs.old }}" \
            --new-sha "${{ steps.content-shas.outputs.new }}" \
            --host "${INDEXNOW_HOST}" \
            --base-url "${INDEXNOW_BASE_URL}" \
            --include-taxonomies \
            > /tmp/indexnow_urls.txt
          wc -l /tmp/indexnow_urls.txt || true

      - name: Submit IndexNow URLs
        id: indexnow
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ ! -s /tmp/indexnow_urls.txt ]; then
              echo "No URLs to submit."
              exit 0
            fi
            python3 scripts/indexnow_submit.py \
              --urls-file /tmp/indexnow_urls.txt \
              --host "${INDEXNOW_HOST}" \
              --key "${INDEXNOW_KEY}"
          else
            # Manual run fallback: submit the full sitemap (first run) or only changed lastmod URLs (subsequent runs)
            python3 scripts/indexnow_submit.py \
              --sitemap "${INDEXNOW_BASE_URL}/sitemap.xml" \
              --host "${INDEXNOW_HOST}" \
              --key "${INDEXNOW_KEY}"
          fi
